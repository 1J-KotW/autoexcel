# Решение Задачи Автоматизации Заполнения Цен в Excel Сметах

![Title](titul.png)

## Постановка Задачи Заказчиком

*"Есть файл excel с множественными вкладками (списки материалов по разным системам). Общее кол-во строк более 15000, частично виды материалов повторяются в разных вкладках/системах.*

*Нужно:*
*-заполнить ячейку на против каждого материала значением цены и значением стоимости работ за единицу*
*-предложить вариант как оптимизировать заполнение ячеек, что бы значения стоимости работ и материалов для одинаковых материалов автоматически копировались из вручную заполненных ячеек"*

## Анализ Проблемы

### Масштаб Задачи
- **15,000+ строк** в одном Excel-файле
- **Множественные вкладки** (листы) с материалами по разным системам
- **Повторяющиеся материалы** в разных вкладках/системах
- **Ручной ввод** цен для каждого вхождения материала

### Основные Проблемы
1. **Огромный объем ручной работы** - заполнение 15,000+ ячеек вручную
2. **Несогласованность данных** - риск ошибок при повторном вводе одних и тех же цен
3. **Низкая эффективность** - повторение одних и тех же действий для одинаковых материалов
4. **Время на обработку** - дни работы вместо автоматизированного процесса

### Требования к Решению
- Автоматическое заполнение цен материалов
- Автоматическое заполнение стоимости работ
- Оптимизация для повторяющихся материалов
- Автоматическое копирование значений из уже заполненных ячеек

## Решение

### Архитектура Решения

Разработана расширенная система на Python с поддержкой базы данных SQLite:

#### Основные Компоненты
- **База данных** (`materials.db`) - SQLite с полной схемой для хранения материалов, цен, заказчиков
- **Управление БД** (`database_manager.py`) - класс для работы с базой данных
- **Импорт цен** (`price_importer.py`) - модуль для загрузки прайсов из Excel/CSV
- **Веб-скрапинг** (`web_price_scraper.py`) - заготовка для парсинга сайтов (placeholder)
- **Управление каталогом** (`manage_catalog.py`) - CLI интерфейс для всех операций
- **Обработка смет** (`fill_prices.py`) - обновленный скрипт с поддержкой БД

#### Структура Базы Данных
- `customers` - заказчики с предпочтениями по источникам цен
- `vendors` - поставщики с URL сайтов
- `materials` - материалы с расширенными полями
- `material_aliases` - алиасы названий для разных заказчиков
- `price_sources` - источники цен (файлы, сайты, ручной ввод)
- `material_prices` - история цен с датами
- `import_sessions` - сессии импорта для отслеживания
- `unmatched_imports` - нераспознанные позиции для ручной обработки

### Как Решается Проблема

#### 1. Автоматическое Заполнение Цен

**Алгоритм работы:**
1. Сканирование всего файла для сбора уже заполненных цен (локальный каталог)
2. Для каждой строки материала:
   - Если цена уже заполнена в файле для этого материала → копирование
   - Если не заполнена → поиск в универсальном справочнике
   - Если не найдена → отметка для ручной обработки

#### 2. Оптимизация для Повторяющихся Материалов

**Ключевой механизм:** Один раз заполнил цену вручную → система автоматически разнесет на все остальные вхождения этого материала во всех вкладках.

**Пример:**
- В смете 50 листов, на каждом "Цемент М400"
- Заполняешь цену один раз на листе 1
- Система автоматически заполнит цену на остальных 49 листах

#### 3. Результат

- **553 позиции** заполнены из локальных данных (уже введенных в файле)
- **90 позиций** заполнены из справочника
- **Остальные** отмечены для ручной обработки
- **Время обработки:** секунды вместо дней ручной работы

### Технологический Стек

- **Язык программирования:** Python 3.6+
- **Библиотека для Excel:** openpyxl
- **Формат хранения данных:** JSON
- **Операционные системы:** Windows, Linux, macOS
- **Зависимости:** openpyxl (pip install openpyxl)

## Архитектура Системы

### Компоненты

- **`materials_catalog.json`** - Универсальный справочник материалов в формате JSON
- **`fill_prices.py`** - Основной скрипт обработки Excel-файлов
- **`add_material.py`** - Утилита управления справочником
- **`create_test_excel.py`** - Генератор тестовых данных

### Структура Справочника

```json
[
  {
    "id": "uuid",
    "name": "Название материала",
    "unit": "единица измерения",
    "price": 100.50,
    "labor_cost": 25.00
  }
]
```

**Поля:**
- `id` - уникальный идентификатор (UUID)
- `name` - каноническое название материала
- `unit` - единица измерения (кг, м³, шт, м², м, л)
- `price` - цена материала за единицу
- `labor_cost` - стоимость работ за единицу

## Установка и Требования

### Системные Требования

- Python 3.6+
- Библиотека `openpyxl` для работы с Excel
- Операционная система: Windows/Linux/MacOS

### Установка Зависимостей

```bash
pip install openpyxl
```

### Подготовка

1. Скачайте все файлы системы в одну папку
2. Убедитесь, что `materials_catalog.json` присутствует
3. Проверьте наличие Python и установленных зависимостей

## Использование

### 1. Управление Справочником Материалов

#### Добавление Нового Материала

```bash
python add_material.py "Цемент М500" кг 6.50 2.80
```

**Параметры:**
- Название материала (в кавычках, если содержит пробелы)
- Единица измерения
- Цена за единицу (число с плавающей точкой)
- Стоимость работ за единицу (число с плавающей точкой)

#### Обновление Существующего Материала

Если материал с таким названием и единицей уже существует, команда обновит его данные:

```bash
python add_material.py "Цемент М400" кг 5.80 2.20
```

### 2. Обработка Excel-Файла Сметы

```bash
python fill_prices.py ваша_смета.xlsx
```

**Результат:**
- Создается новый файл `ваша_смета_filled.xlsx`
- Добавляются необходимые столбцы (если отсутствуют)
- Автоматически заполняются цены
- Выводится отчет о результатах обработки

### 3. Тестирование Системы

```bash
# Создание тестового файла с 1000 строками
python create_test_excel.py

# Обработка тестового файла
python fill_prices.py large_test_smeta.xlsx
```

## Структура Excel-Файла

### Обязательные Столбцы

| Столбец | Название | Описание |
|---------|----------|----------|
| A | Материал | Название материала |
| B | Единица измерения | Единица измерения материала |

### Добавляемые Столбцы

| Столбец | Название | Описание |
|---------|----------|----------|
| C | Цена материала, за единицу | Автоматически заполняемая цена |
| D | Стоимость работ, за единицу | Автоматически заполняемая стоимость работ |
| E | Статус заполнения | Статус обработки строки |

### Пример Структуры

```
| Материал              | Единица измерения | Количество | Цена материала, за единицу | Стоимость работ, за единицу | Статус заполнения    |
|-----------------------|-------------------|------------|----------------------------|-----------------------------|----------------------|
| Цемент М400          | кг               | 100       | 5.50                      | 2.00                       | Заполнено (справочник) |
| Песок речной         | м³               | 5         | 800.00                    | 150.00                     | Заполнено (локальный)  |
| Кирпич красный       | шт               | 500       |                           |                            | Не найдено           |
```

## Алгоритм Работы

### Этап 1: Сбор Локальных Данных

1. Сканируются все листы файла
2. Собираются материалы с уже заполненными ценами
3. Формируется локальный каталог: `{(название, единица): (цена, стоимость)}`

### Этап 2: Заполнение Данных

Для каждой строки в файле:

1. **Проверка локальных данных** - если материал найден в локальном каталоге
   - Копируется цена и стоимость работ
   - Статус: "Заполнено (локальный)"

2. **Проверка справочника** - если не найдено локально
   - Ищется точное совпадение в `materials_catalog.json`
   - Заполняются найденные значения
   - Статус: "Заполнено (справочник)"

3. **Отметка для ручной обработки** - если не найдено нигде
   - Статус: "Не найдено"
   - Добавляется в отчет

### Этап 3: Генерация Отчета

- Количество заполненных позиций (локально/справочник)
- Список материалов, требующих ручной обработки
- Список неоднозначных совпадений (если есть)

## Оптимизация и Эффективность

### Преимущества Подхода

1. **Минимизация ручного ввода** - один раз заполнил цену для материала, система разнесет на все вхождения
2. **Масштабируемость** - работает с файлами 15,000+ строк
3. **Гибкость** - поддержка множественных листов и систем
4. **Безопасность** - не перезаписывает уже заполненные ячейки

### Примеры Оптимизации

**Сценарий:** В смете 50 листов, на каждом есть "Цемент М400" в разных количествах.

**Без оптимизации:** Нужно заполнить цену 50 раз вручную.

**С оптимизацией:** Заполняешь цену один раз на любом листе → система автоматически заполнит на остальных 49 листах.

### Производительность

- **Тестовый прогон:** 1000 строк, 5 листов - обработка за секунды
- **Реальные данные:** 15,000 строк - обработка в течение минуты
- **Память:** Эффективное использование, локальный каталог хранится в памяти

## Расширение и Интеграция

### Будущие Возможности

1. **История цен** - хранение нескольких цен с датами
2. **Несколько источников** - прайсы, сайты поставщиков
3. **Нечеткое сопоставление** - fuzzy matching для названий
4. **Автоматическое обновление** - парсинг прайсов
5. **Множественные справочники** - по заказчикам/проектам

## Устранение Неисправностей

### Распространенные Проблемы

#### 1. Ошибка "Catalog file not found"

**Симптом:** `FileNotFoundError: materials_catalog.json`

**Решение:** Убедитесь, что файл `materials_catalog.json` находится в той же папке, что и скрипты.

#### 2. Ошибка "Missing required columns"

**Симптом:** `Sheet 'Лист1' missing required columns 'Материал' or 'Единица измерения'`

**Решение:** Проверьте структуру Excel-файла. Обязательны столбцы "Материал" и "Единица измерения".

#### 3. Цены не заполняются

**Симптом:** Все строки имеют статус "Не найдено"

**Решение:**
- Проверьте корректность названий материалов в справочнике
- Убедитесь в совпадении единиц измерения
- Добавьте недостающие материалы в справочник

### Логи и Отладка

Система выводит подробную информацию в консоль:
- Количество обработанных позиций
- Источники заполнения (локальный/справочник)
- Список проблемных материалов

### Проверка Качества Данных

Рекомендуется после обработки:
1. Открыть `_filled.xlsx` файл
2. Проверить случайно выбранные заполненные позиции
3. Убедиться, что существующие данные не перезаписаны
4. Проверить логику копирования для повторяющихся материалов

## Поддержка и Развитие

### Сообщение об Ошибках

При обнаружении проблем:
1. Проверьте логи выполнения
2. Убедитесь в корректности входных данных
3. Проверьте структуру Excel-файла

### Структура Новой Базы Данных

- **Заказчики** (`customers`) - с предпочтениями по источникам цен
- **Поставщики** (`vendors`) - с URL сайтов для будущего парсинга
- **Материалы** (`materials`) - расширенные поля (категория, поставщик)
- **Алиасы материалов** (`material_aliases`) - разные названия для заказчиков
- **Источники цен** (`price_sources`) - файлы, сайты, ручной ввод
- **История цен** (`material_prices`) - цены с датами и источниками
- **Сессии импорта** (`import_sessions`) - отслеживание загрузок
- **Нераспознанные позиции** (`unmatched_imports`) - для ручной обработки

### Преимущества Расширенной Версии

1. **Множественные заказчики** - разные справочники и предпочтения
2. **История цен** - отслеживание изменений во времени
3. **Автоматические обновления** - из прайсов и сайтов
4. **Масштабируемость** - поддержка больших объемов данных
5. **Гибкость** - адаптация под разные форматы и требования
